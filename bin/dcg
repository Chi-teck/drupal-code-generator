#!/usr/bin/env php
<?php

$autoloader = require __DIR__ . '/../vendor/autoload.php';

use DrupalCodeGenerator\GeneratorDiscovery;
use DrupalCodeGenerator\TwigEnvironment;
use DrupalCodeGenerator\Commands;
use Symfony\Component\Console\Application;
use Symfony\Component\Filesystem\Filesystem;
use Symfony\Component\Yaml\Dumper;

// Setup target directories.
if (file_exists(DCG_HOME . '/Commands')) {
  $commands_directories[] = DCG_HOME . '/Commands';
  $autoloader->addPsr4('DrupalCodeGenerator\\', DCG_HOME);
}
if (file_exists(DCG_HOME . '/Templates')) {
  $twig_directories[] = DCG_HOME . '/Ttemplates';
}
$commands_directories[] = DCG_ROOT . '/src/Commands';
$twig_directories[] = DCG_ROOT . '/src/Templates';

// Discover generators.
$twig_loader = new Twig_Loader_Filesystem($twig_directories);
$twig = new TwigEnvironment($twig_loader);
$yaml_dumper = new Dumper();
$yaml_dumper->setIndentation(2);
$discovery = new GeneratorDiscovery($commands_directories, new Filesystem(), $twig, $yaml_dumper);
$generators = $discovery->getGenerators();

// Create navigation command.
$navigation = new Commands\Navigation();
$navigation->init($generators);

// Build application.
$application = new Application('Drupal Code Generator', '@git-version@');
$application->addCommands($generators);
$application->add($navigation);
$application->setDefaultCommand('navigation');
$application->run();
